<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台股自動化戰情室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        .tw-up { color: #ef4444; }
        .tw-down { color: #22c55e; }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #0f172a; 
            color: #e2e8f0;
            overscroll-behavior-y: contain; 
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .tab-btn.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; }
        .tab-btn { color: #94a3b8; border-bottom: 2px solid transparent; }
        th.sortable { cursor: pointer; transition: background-color 0.2s; user-select: none; white-space: nowrap; }
        th.sortable:hover { background-color: #334155; }
        td { white-space: nowrap; }
        .name-cell { white-space: normal; max-width: 80px; line-height: 1.2; }
        
        @keyframes pulse-blue { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-updating { animation: pulse-blue 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; color: #60a5fa; }
        .live-indicator { animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden bg-slate-900">

    <!-- Top Navbar -->
    <nav class="bg-slate-950 text-white p-3 shadow-lg shrink-0 z-40 border-b border-slate-800 flex justify-between items-center h-14">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-chart-simple text-blue-400 text-lg"></i>
            <div class="flex flex-col">
                <h1 class="text-sm font-bold tracking-wider leading-none">台股戰情室</h1>
                <div class="text-[9px] text-gray-500 mt-0.5" id="last-updated">讀取中...</div>
            </div>
        </div>
        
        <!-- 右側按鈕群組 (雲端更新/重整) -->
        <div class="flex items-center gap-1">
            <button onclick="app.triggerCloudUpdate()" id="btn-cloud-update" class="flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-blue-400 border border-slate-700 px-3 py-1.5 rounded-full transition-all active:scale-95 shadow-sm">
                <i class="fa-solid fa-cloud-arrow-down text-sm"></i>
                <span class="text-[10px] font-medium">更新</span>
            </button>
            <button onclick="app.refresh()" class="p-2 text-gray-500 hover:text-white transition-colors active:scale-95">
                <i class="fa-solid fa-rotate-right text-sm"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col w-full max-w-6xl mx-auto p-2 overflow-hidden relative pb-16">
        
        <!-- PAGE 1: Heatmap -->
        <div id="page-heatmap" class="flex flex-col h-full gap-2">
            <div class="flex-grow overflow-y-auto pb-4">
                <div id="heatmap-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
            </div>
        </div>

        <!-- PAGE 2: List -->
        <div id="page-list" class="hidden flex flex-col h-full gap-2">
            <!-- Control Area -->
            <div class="shrink-0 flex flex-col gap-2">
                <!-- 狀態列與過濾標籤 -->
                <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded-lg border border-slate-700">
                    <div class="flex items-center gap-2">
                        <span id="filter-tag" class="hidden text-[10px] bg-blue-900/50 text-blue-200 px-2 py-0.5 rounded border border-blue-700 flex items-center">
                            <span id="filter-name">族群</span>
                            <button onclick="app.clearFilter()" class="ml-2 hover:text-white"><i class="fa-solid fa-times"></i></button>
                        </span>
                        <span id="data-count" class="text-[10px] text-gray-400">0 檔</span>
                    </div>
                    
                    <button onclick="app.toggleMaFilter()" id="btn-ma-filter" class="bg-slate-700 text-gray-300 text-[10px] font-bold py-1 px-2.5 rounded shadow active:scale-95 transition-all">
                        過濾支撐
                    </button>
                </div>
            </div>

            <!-- List Panel -->
            <div class="glass-panel flex-grow flex flex-col overflow-hidden rounded-xl border border-white/10">
                <div class="flex-grow overflow-auto bg-slate-900 relative">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-500 uppercase bg-slate-950 sticky top-0 shadow-sm z-20">
                            <tr>
                                <th scope="col" class="px-2 py-3 sortable sticky left-0 bg-slate-950 z-30 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] border-r border-slate-800 text-gray-300" onclick="app.sortList('id')">
                                    股名 <i class="sort-icon fa-solid fa-sort text-[10px] ml-0.5 text-slate-600" id="sort-icon-id"></i>
                                </th>
                                <th scope="col" class="px-2 py-3 sortable text-center" onclick="app.sortList('group')">
                                    族群 <i class="sort-icon fa-solid fa-sort text-[10px] ml-0.5 text-slate-600" id="sort-icon-group"></i>
                                </th>
                                <th scope="col" class="px-2 py-3 text-right sortable" onclick="app.sortList('price')">
                                    價 <i class="sort-icon fa-solid fa-sort text-[10px] ml-0.5 text-slate-600" id="sort-icon-price"></i>
                                </th>
                                <th scope="col" class="px-2 py-3 text-right sortable" onclick="app.sortList('changeRate')">
                                    漲跌 <i class="sort-icon fa-solid fa-sort text-[10px] ml-0.5 text-slate-600" id="sort-icon-changeRate"></i>
                                </th>
                                <th scope="col" class="px-2 py-3 text-right text-[10px]">MA5</th>
                                <th scope="col" class="px-2 py-3 text-right text-[10px]">MA10</th>
                                <th scope="col" class="px-2 py-3 text-[10px]">備註</th>
                            </tr>
                        </thead>
                        <tbody id="result-body" class="divide-y divide-slate-800">
                            <tr><td colspan="7" class="px-6 py-20 text-center text-gray-600"><i class="fa-solid fa-spinner fa-spin text-2xl mb-4 text-blue-500"></i><br>載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PAGE 3: Admin -->
        <div id="page-admin" class="hidden h-full overflow-y-auto">
            <div class="glass-panel rounded-xl p-6 max-w-2xl mx-auto mb-4 bg-slate-800">
                <h2 class="text-lg font-bold mb-4 flex items-center border-b border-slate-700 pb-3 text-white"><i class="fa-solid fa-gear mr-2 text-gray-400"></i>設定</h2>
                <div class="space-y-3 text-sm">
                    <p class="text-xs text-yellow-500 bg-yellow-900/20 p-2 rounded border border-yellow-800">
                        <i class="fa-solid fa-circle-info mr-1"></i> 請填寫 Token 以啟用雲端更新。
                    </p>
                    <input type="text" id="repo-owner" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white placeholder-gray-500" placeholder="GitHub Owner">
                    <input type="text" id="repo-name" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white placeholder-gray-500" placeholder="Repo Name">
                    <input type="password" id="github-token" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white placeholder-gray-500" placeholder="Access Token">
                    <button onclick="admin.saveSettings()" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded mt-2">儲存設定</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-800 z-50 h-16 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)]">
        <div class="max-w-6xl mx-auto flex justify-around h-full">
            <button onclick="app.switchTab('heatmap')" id="tab-heatmap" class="tab-btn active flex-1 flex flex-col items-center justify-center">
                <i class="fa-solid fa-fire text-lg mb-1"></i>
                <span class="text-xs mt-1">熱力圖</span>
            </button>
            <button onclick="app.switchTab('list')" id="tab-list" class="tab-btn flex-1 flex flex-col items-center justify-center">
                <i class="fa-solid fa-list-ul text-lg mb-1"></i>
                <span class="text-xs mt-1">報價</span>
            </button>
            <button onclick="app.switchTab('admin')" id="tab-admin" class="tab-btn flex-1 flex flex-col items-center justify-center">
                <i class="fa-solid fa-gear text-lg mb-1"></i>
                <span class="text-xs mt-1">設定</span>
            </button>
        </div>
    </nav>

    <script>
        class StockApp {
            constructor() {
                this.dataUrl = 'data.json';
                this.stockList = []; 
                this.displayList = []; 
                
                this.state = {
                    sortBy: 'changeRate', 
                    sortDir: 'desc',
                    filterGroup: null,
                    filterMa: false
                };

                this.lastDataTime = "";
                this.isPolling = false; // 用於 GitHub Action 監聽

                this.ui = {
                    body: document.getElementById('result-body'),
                    lastUpdated: document.getElementById('last-updated'),
                    dataCount: document.getElementById('data-count'),
                    filterTag: document.getElementById('filter-tag'),
                    filterName: document.getElementById('filter-name'),
                    heatmapContainer: document.getElementById('heatmap-container'),
                    btnCloudUpdate: document.getElementById('btn-cloud-update'),
                    btnMaFilter: document.getElementById('btn-ma-filter'),
                    
                    pageHeatmap: document.getElementById('page-heatmap'),
                    pageList: document.getElementById('page-list'),
                    pageAdmin: document.getElementById('page-admin'),
                    
                    tabHeatmap: document.getElementById('tab-heatmap'),
                    tabList: document.getElementById('tab-list'),
                    tabAdmin: document.getElementById('tab-admin')
                };
                this.init();
            }

            refresh() { location.reload(); }

            switchTab(tabName) {
                // 隱藏所有頁面
                ['pageHeatmap', 'pageList', 'pageAdmin'].forEach(p => this.ui[p].classList.add('hidden'));
                ['tabHeatmap', 'tabList', 'tabAdmin'].forEach(t => this.ui[t].classList.remove('active'));

                // 顯示目標頁面
                if (tabName === 'heatmap') {
                    this.ui.pageHeatmap.classList.remove('hidden');
                    this.ui.tabHeatmap.classList.add('active');
                    this.renderHeatmap();
                } else if (tabName === 'list') {
                    this.ui.pageList.classList.remove('hidden');
                    this.ui.tabList.classList.add('active');
                    this.applyStateAndRender();
                } else if (tabName === 'admin') {
                    this.ui.pageAdmin.classList.remove('hidden');
                    this.ui.tabAdmin.classList.add('active');
                    admin.loadSettings();
                }
            }

            async init() {
                try { await this.loadData(); } 
                catch (e) { this.ui.body.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-amber-500 text-xs">${e.message}</td></tr>`; }
            }

            async loadData() {
                const cacheBuster = new Date().getTime();
                let response;
                try { response = await fetch(`${this.dataUrl}?t=${cacheBuster}`); } 
                catch (netError) { throw new Error("預覽環境無法讀取資料"); }
                if (response.status === 404) throw new Error("初次使用請至設定頁觸發掃描");
                if (!response.ok) throw new Error("讀取失敗");
                
                const data = await response.json();
                this.stockList = data.list || [];
                
                if (this.lastDataTime && this.lastDataTime !== data.date) {
                    alert(`✅ 報價已更新！\n時間: ${data.date}`);
                    this.stopPolling();
                }
                this.lastDataTime = data.date;

                this.ui.lastUpdated.innerText = `更新: ${data.date.split(' ')[1] || data.date}`;
                
                this.renderHeatmap();
                // 載入新資料後，重新套用當前的過濾與排序狀態
                this.applyStateAndRender();
            }

            // === 核心狀態處理 (保持過濾與排序) ===
            applyStateAndRender() {
                let list = [...this.stockList];

                // 1. 套用族群過濾
                if (this.state.filterGroup) {
                    list = list.filter(s => (s.group || '其他') === this.state.filterGroup);
                    this.ui.filterTag.classList.remove('hidden');
                    this.ui.filterName.innerText = this.state.filterGroup;
                } else {
                    this.ui.filterTag.classList.add('hidden');
                }

                // 2. 套用均線支撐過濾
                if (this.state.filterMa) {
                    list = list.filter(s => s.price > s.ma5 && s.price > s.ma10);
                    this.ui.btnMaFilter.classList.remove('bg-slate-700', 'text-gray-300');
                    this.ui.btnMaFilter.classList.add('bg-indigo-600', 'text-white');
                } else {
                    this.ui.btnMaFilter.classList.add('bg-slate-700', 'text-gray-300');
                    this.ui.btnMaFilter.classList.remove('bg-indigo-600', 'text-white');
                }

                // 3. 套用排序
                if (this.state.sortBy) {
                    const dir = this.state.sortDir === 'asc' ? 1 : -1;
                    list.sort((a, b) => {
                        let valA = a[this.state.sortBy];
                        let valB = b[this.state.sortBy];
                        
                        if (this.state.sortBy === 'price' || this.state.sortBy === 'changeRate') 
                            return (parseFloat(valA) - parseFloat(valB)) * dir;
                        return (valA || '').localeCompare(valB || '', 'zh-Hant') * dir;
                    });
                    
                    // 【修復點】更新排序圖示：使用 setAttribute('class', ...) 並增加錯誤防護
                    try {
                         document.querySelectorAll('.sort-icon').forEach(el => {
                            el.setAttribute('class', 'sort-icon fa-solid fa-sort text-[10px] ml-0.5 text-slate-600');
                        });
                        const activeIcon = document.getElementById(`sort-icon-${this.state.sortBy}`);
                        if(activeIcon) {
                            activeIcon.setAttribute('class', `sort-icon fa-solid fa-sort-${this.state.sortDir === 'asc' ? 'up' : 'down'} text-[10px] ml-0.5 text-blue-400`);
                        }
                    } catch(e) {
                         console.warn("排序圖示更新失敗 (Rtml 環境限制):", e);
                    }
                }

                this.displayList = list;
                this.renderTable(this.displayList);
                this.updateCount();
            }

            // === 用戶操作與控制 ===
            filterByGroup(groupName) {
                this.state.filterGroup = groupName;
                this.switchTab('list');
                this.applyStateAndRender();
            }

            clearFilter() {
                this.state.filterGroup = null;
                this.applyStateAndRender();
            }

            toggleMaFilter() {
                this.state.filterMa = !this.state.filterMa;
                this.applyStateAndRender();
            }

            sortList(key) {
                if (this.state.sortBy === key) {
                    this.state.sortDir = this.state.sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.state.sortBy = key;
                    this.state.sortDir = 'asc'; // 預設升冪
                }
                this.applyStateAndRender();
            }
            
            // 【雲端更新邏輯】
            async triggerCloudUpdate() {
                const owner = localStorage.getItem('gh_owner');
                const repo = localStorage.getItem('gh_repo');
                const token = localStorage.getItem('gh_token');
                if (!owner || !repo || !token) { alert("請先至設定頁填寫 Token"); this.switchTab('admin'); return; }
                if (!confirm("確定要更新報價嗎？\n(將觸發後端 Python 抓取最新真實報價)")) return;

                this.ui.btnCloudUpdate.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin animate-updating"></i>`;
                this.ui.btnCloudUpdate.disabled = true;

                try {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/daily_scan.yml/dispatches`, {
                        method: 'POST', 
                        headers: { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `token ${token}` }, 
                        body: JSON.stringify({ ref: 'main' })
                    });
                    if (res.status === 204) { this.startPolling(); } else { throw new Error(`Status ${res.status}`); }
                } catch (e) { alert("發送失敗：" + e.message); this.resetUpdateButton(); }
            }

            startPolling() {
                if (this.isPolling) return;
                this.isPolling = true;
                this.ui.lastUpdated.classList.add("animate-pulse", "text-blue-400");
                // 每 15 秒檢查一次 data.json 是否已經被 GitHub Action 更新
                this.pollInterval = setInterval(() => { this.loadData(); }, 15000);
            }
            stopPolling() {
                this.isPolling = false;
                clearInterval(this.pollInterval);
                this.resetUpdateButton();
                this.ui.lastUpdated.classList.remove("animate-pulse", "text-blue-400");
            }
            resetUpdateButton() {
                this.ui.btnCloudUpdate.innerHTML = `<i class="fa-solid fa-cloud-arrow-down text-sm"></i><span class="text-[10px] font-medium">更新</span>`;
                this.ui.btnCloudUpdate.disabled = false;
            }


            // === 渲染邏輯 ===
            renderHeatmap() {
                if (this.stockList.length === 0) return;
                const groups = {};
                this.stockList.forEach(stock => {
                    const gName = stock.group || '其他';
                    if (!groups[gName]) groups[gName] = { totalChange: 0, count: 0 };
                    groups[gName].totalChange += parseFloat(stock.changeRate || 0);
                    groups[gName].count++;
                });
                const groupArray = Object.keys(groups).map(key => ({
                    name: key,
                    avgChange: (groups[key].totalChange / groups[key].count).toFixed(2),
                    count: groups[key].count
                })).sort((a, b) => b.avgChange - a.avgChange);

                this.ui.heatmapContainer.innerHTML = groupArray.map(g => {
                    const rate = parseFloat(g.avgChange);
                    let colorClass = 'bg-slate-700';
                    if (rate > 2) colorClass = 'bg-red-600';
                    else if (rate > 0) colorClass = 'bg-red-900/80';
                    else if (rate < -2) colorClass = 'bg-green-600';
                    else if (rate < 0) colorClass = 'bg-green-900/80';

                    return `
                        <div onclick="app.filterByGroup('${g.name}')" class="${colorClass} p-3 rounded-lg shadow cursor-pointer active:scale-95 transition-transform flex flex-col justify-between h-24 border border-white/10 hover:border-white/30">
                            <span class="text-sm font-bold text-white truncate">${g.name}</span>
                            <div class="flex justify-between items-end">
                                <span class="text-xs text-gray-300">${g.count}檔</span>
                                <span class="text-lg font-bold text-white">${rate>0?'+':''}${rate}%</span>
                            </div>
                        </div>`;
                }).join('');
            }

            renderTable(list) {
                if (list.length === 0) { this.ui.body.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">無符合資料</td></tr>`; return; }
                const html = list.map(stock => {
                    const rate = parseFloat(stock.changeRate||0);
                    const price = stock.price.toFixed(2);
                    
                    let priceClass = rate > 0 ? 'tw-up font-bold' : (rate < 0 ? 'tw-down font-bold' : 'text-white font-bold');
                    let rateDisplay = rate > 0 ? `+${rate.toFixed(2)}%` : `${rate.toFixed(2)}%`;
                    const typeBadge = stock.type === '上市' ? '<span class="bg-blue-900 text-blue-300 text-[9px] px-1 rounded border border-blue-800">市</span>' : '<span class="bg-purple-900 text-purple-300 text-[9px] px-1 rounded border border-purple-800">櫃</span>';
                    
                    let shortGroup = stock.group || '-';
                    if (shortGroup !== '-' && shortGroup !== '其他' && shortGroup.length > 2) shortGroup = shortGroup.substring(0, 2);
                    const groupBadge = stock.group && stock.group !== '其他' ? `<span class="bg-slate-800 text-gray-400 text-[10px] px-1 py-0.5 rounded border border-slate-700">${shortGroup}</span>` : `<span class="text-gray-600 text-[10px]">-</span>`;
                    
                    return `
                        <tr class="hover:bg-slate-800 transition-colors border-b border-slate-800">
                            <td class="px-2 py-3 sticky left-0 bg-slate-900 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] border-r border-slate-800 z-10">
                                <div class="flex items-center gap-1.5">
                                    <div class="flex flex-col w-[70px]">
                                        <div class="text-white text-xs font-bold leading-tight name-cell">${stock.name}</div>
                                        <div class="text-gray-500 text-[10px] flex items-center gap-1 mt-0.5">${stock.id} ${typeBadge}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-2 py-3 text-center align-middle">${groupBadge}</td>
                            <td class="px-2 py-3 text-right ${priceClass} text-sm">${price}</td>
                            <td class="px-2 py-3 text-right ${priceClass} text-xs">${rateDisplay}</td>
                            <td class="px-2 py-3 text-right text-[10px] text-gray-500 font-mono">${stock.ma5}</td>
                            <td class="px-2 py-3 text-right text-[10px] text-gray-500 font-mono">${stock.ma10}</td>
                            <td class="px-2 py-3 text-[10px] text-gray-600 whitespace-nowrap">${stock.note || '-'}</td>
                        </tr>`;
                }).join('');
                this.ui.body.innerHTML = html;
            }

            updateCount() { this.ui.dataCount.innerText = `${this.displayList.length} 檔`; }
        }

        class AdminController {
            constructor() {
                this.ui = { owner: document.getElementById('repo-owner'), repo: document.getElementById('repo-name'), token: document.getElementById('github-token') };
            }
            loadSettings() { this.ui.owner.value = localStorage.getItem('gh_owner')||''; this.ui.repo.value = localStorage.getItem('gh_repo')||''; this.ui.token.value = localStorage.getItem('gh_token')||''; }
            saveSettings() { 
                localStorage.setItem('gh_owner', this.ui.owner.value.trim()); 
                localStorage.setItem('gh_repo', this.ui.repo.value.trim()); 
                localStorage.setItem('gh_token', this.ui.token.value.trim()); 
                alert('設定已儲存！');
            }
        }
        const app = new StockApp(); const admin = new AdminController();
    </script>
</body>
</html>
