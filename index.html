<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台股自動化戰情室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        /* 台股紅漲綠跌設定 */
        .tw-up { color: #ef4444; }
        .tw-down { color: #22c55e; }
        /* 暗黑模式基礎 */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        /* 玻璃擬態面板 - 暗色版 */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        .tab-btn.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; }
        .tab-btn { color: #94a3b8; border-bottom: 2px solid transparent; }
        
        th.sortable { cursor: pointer; transition: background-color 0.2s; user-select: none; white-space: nowrap; }
        th.sortable:hover { background-color: #334155; } /* Hover 深灰色 */
        
        /* 強制不換行，但在名稱欄位允許換行以節省寬度 */
        td { white-space: nowrap; }
        
        /* 針對名稱欄位的微調，允許文字過長時換行，但限制最大寬度 */
        .name-cell {
            white-space: normal;
            max-width: 80px; /* 限制寬度，避免撐大 */
            line-height: 1.2;
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden bg-slate-900">

    <!-- Top Navbar -->
    <nav class="bg-slate-950 text-white p-3 shadow-lg shrink-0 z-40 border-b border-slate-800">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-chart-simple text-blue-400 text-xl"></i>
                <div>
                    <h1 class="text-base font-bold tracking-wider">台股戰情室</h1>
                    <div class="text-[10px] text-gray-500" id="last-updated">讀取中...</div>
                </div>
            </div>
            <button onclick="app.refresh()" class="p-2 bg-slate-800 rounded-full hover:bg-slate-700 active:scale-95 transition-transform text-gray-300">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col w-full max-w-6xl mx-auto p-2 overflow-hidden relative pb-16">
        
        <!-- PAGE 1: Dashboard -->
        <div id="page-dashboard" class="flex flex-col h-full gap-2">
            
            <!-- Control Area -->
            <div class="shrink-0 flex flex-col gap-2">
                <div id="status-banner" class="bg-blue-900/50 border border-blue-800 text-blue-100 px-3 py-2 rounded-lg text-xs flex justify-between items-center hidden">
                    <span><i class="fa-solid fa-check-circle mr-1 text-blue-400"></i>資料已載入</span>
                    <span id="data-count" class="bg-blue-950 px-2 py-0.5 rounded text-[10px] text-blue-300">0 檔</span>
                </div>

                <button onclick="app.runCompareScan()" id="btn-compare" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center transition-all border border-blue-500/50">
                    <i class="fa-solid fa-filter mr-2"></i> 過濾均線支撐
                </button>
            </div>

            <!-- List Panel -->
            <div class="glass-panel flex-grow flex flex-col overflow-hidden rounded-xl">
                <!-- Header -->
                <div class="flex justify-between items-center p-2 border-b border-slate-700 bg-slate-800/50 shrink-0">
                    <h2 class="text-sm font-bold flex items-center text-gray-300">
                        <i class="fa-solid fa-list-ul mr-2 text-blue-400"></i>自選清單
                    </h2>
                    <span id="filtered-badge" class="hidden text-[10px] bg-red-900/50 text-red-300 px-2 py-0.5 rounded border border-red-800">已過濾</span>
                </div>
                
                <!-- Table Container -->
                <div class="flex-grow overflow-auto bg-slate-900 relative">
                    <!-- min-w 設定稍微縮小，讓使用者更願意左右滑，但在小螢幕也能看到重點 -->
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-500 uppercase bg-slate-950 sticky top-0 shadow-sm z-20">
                            <tr>
                                <!-- 固定首欄：背景改為深色 bg-slate-900 -->
                                <th scope="col" class="px-2 py-3 sortable sticky left-0 bg-slate-950 z-30 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] border-r border-slate-800 text-gray-300" onclick="app.sortList('id')">
                                    股名
                                </th>
                                <th scope="col" class="px-2 py-3 sortable text-center" onclick="app.sortList('group')">
                                    族群
                                </th>
                                <th scope="col" class="px-2 py-3 text-right sortable" onclick="app.sortList('price')">
                                    價
                                </th>
                                <th scope="col" class="px-2 py-3 text-right sortable" onclick="app.sortList('changeRate')">
                                    漲跌
                                </th>
                                <th scope="col" class="px-2 py-3 text-right text-[10px]">MA5</th>
                                <th scope="col" class="px-2 py-3 text-right text-[10px]">MA10</th>
                                <th scope="col" class="px-2 py-3 text-[10px]">備註</th>
                            </tr>
                        </thead>
                        <tbody id="result-body" class="divide-y divide-slate-800">
                            <tr><td colspan="7" class="px-6 py-20 text-center text-gray-600"><i class="fa-solid fa-spinner fa-spin text-2xl mb-4 text-blue-500"></i><br>載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="page-admin" class="hidden h-full overflow-y-auto">
            <div class="glass-panel rounded-xl p-6 max-w-2xl mx-auto mb-4 bg-slate-800">
                <h2 class="text-lg font-bold mb-4 flex items-center border-b border-slate-700 pb-3 text-white"><i class="fa-solid fa-rocket mr-2 text-red-500"></i>手動執行</h2>
                <div class="space-y-3 text-sm">
                    <div>
                        <label class="block text-gray-400 mb-1">GitHub Owner</label>
                        <input type="text" id="repo-owner" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1">Repo Name</label>
                        <input type="text" id="repo-name" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1">Access Token</label>
                        <input type="password" id="github-token" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <button onclick="admin.triggerWorkflow()" id="btn-trigger" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded mt-2">執行</button>
                    <div id="admin-log" class="mt-2 p-2 bg-black text-green-400 font-mono text-xs rounded h-24 overflow-y-auto hidden border border-slate-700"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-800 z-50 h-16 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)]">
        <div class="max-w-6xl mx-auto flex justify-around h-full">
            <button onclick="app.switchTab('dashboard')" id="tab-dashboard" class="tab-btn active flex-1 flex flex-col items-center justify-center">
                <i class="fa-solid fa-chart-line text-lg mb-1"></i>
                <span class="text-xs mt-1">報價</span>
            </button>
            <button onclick="app.switchTab('admin')" id="tab-admin" class="tab-btn flex-1 flex flex-col items-center justify-center">
                <i class="fa-solid fa-gear text-lg mb-1"></i>
                <span class="text-xs mt-1">設定</span>
            </button>
        </div>
    </nav>

    <script>
        class StockApp {
            constructor() {
                this.dataUrl = 'data.json';
                this.stockList = [];
                this.displayList = [];
                this.sortState = { key: null, direction: 'asc' };
                this.ui = {
                    body: document.getElementById('result-body'),
                    lastUpdated: document.getElementById('last-updated'),
                    statusBanner: document.getElementById('status-banner'),
                    dataCount: document.getElementById('data-count'),
                    btnCompare: document.getElementById('btn-compare'),
                    filteredBadge: document.getElementById('filtered-badge'),
                    pageDashboard: document.getElementById('page-dashboard'),
                    pageAdmin: document.getElementById('page-admin'),
                    tabDashboard: document.getElementById('tab-dashboard'),
                    tabAdmin: document.getElementById('tab-admin')
                };
                this.init();
            }
            refresh() { location.reload(); }
            switchTab(tabName) {
                if (tabName === 'dashboard') {
                    this.ui.pageDashboard.classList.remove('hidden');
                    this.ui.pageAdmin.classList.add('hidden');
                    this.ui.tabDashboard.classList.add('active');
                    this.ui.tabAdmin.classList.remove('active');
                } else {
                    this.ui.pageDashboard.classList.add('hidden');
                    this.ui.pageAdmin.classList.remove('hidden');
                    this.ui.tabDashboard.classList.remove('active');
                    this.ui.tabAdmin.classList.add('active');
                    admin.loadSettings();
                }
            }
            async init() {
                try {
                    const cacheBuster = new Date().getTime();
                    let response;
                    try { response = await fetch(`${this.dataUrl}?t=${cacheBuster}`); } 
                    catch (netError) { throw new Error("預覽環境無法讀取資料，請部署至 GitHub Pages。"); }
                    if (response.status === 404) throw new Error("初次使用請至設定頁觸發掃描");
                    if (!response.ok) throw new Error("讀取失敗");
                    const data = await response.json();
                    this.stockList = data.list || [];
                    this.displayList = [...this.stockList];
                    this.ui.lastUpdated.innerText = `更新: ${data.date.split(' ')[1] || data.date}`;
                    this.ui.statusBanner.classList.remove('hidden');
                    this.ui.dataCount.innerText = `${this.stockList.length}`;
                    if(this.stockList.length > 0) this.ui.btnCompare.disabled = false;
                    this.renderTable(this.displayList);
                } catch (e) {
                    this.ui.body.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-amber-500 font-bold px-4 text-xs">${e.message}</td></tr>`;
                    this.ui.btnCompare.disabled = true;
                }
            }
            runCompareScan() {
                this.displayList = this.stockList.filter(stock => stock.price > stock.ma5 && stock.price > stock.ma10);
                this.renderTable(this.displayList);
                this.ui.filteredBadge.classList.remove('hidden');
                this.ui.filteredBadge.innerText = `剩 ${this.displayList.length}`;
            }
            sortList(key) {
                if (this.sortState.key === key) this.sortState.direction = this.sortState.direction === 'asc' ? 'desc' : 'asc';
                else { this.sortState.key = key; this.sortState.direction = 'asc'; }
                const dir = this.sortState.direction === 'asc' ? 1 : -1;
                this.displayList.sort((a, b) => {
                    let valA = a[key], valB = b[key];
                    if (key === 'price' || key === 'changeRate') return (valA - valB) * dir;
                    return (valA || '').localeCompare(valB || '', 'zh-Hant') * dir;
                });
                this.renderTable(this.displayList);
            }
            renderTable(list) {
                if (list.length === 0) { this.ui.body.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">無符合資料</td></tr>`; return; }
                const html = list.map(stock => {
                    const rate = parseFloat(stock.changeRate||0);
                    let priceClass = rate > 0 ? 'tw-up font-bold' : (rate < 0 ? 'tw-down font-bold' : 'text-white font-bold');
                    let rateDisplay = rate > 0 ? `+${rate}%` : `${rate}%`;
                    const typeBadge = stock.type === '上市' ? '<span class="bg-blue-900 text-blue-300 text-[9px] px-1 rounded border border-blue-800">市</span>' : '<span class="bg-purple-900 text-purple-300 text-[9px] px-1 rounded border border-purple-800">櫃</span>';
                    
                    let shortGroup = stock.group || '-';
                    if (shortGroup !== '-' && shortGroup !== '其他' && shortGroup.length > 2) {
                        shortGroup = shortGroup.substring(0, 2);
                    }
                    const groupBadge = stock.group && stock.group !== '其他' ? `<span class="bg-slate-800 text-gray-400 text-[10px] px-1 py-0.5 rounded border border-slate-700">${shortGroup}</span>` : `<span class="text-gray-600 text-[10px]">-</span>`;
                    
                    return `
                        <tr class="hover:bg-slate-800 transition-colors">
                            <td class="px-2 py-3 sticky left-0 bg-slate-900 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] border-r border-slate-800 z-10">
                                <div class="flex items-center gap-1.5">
                                    <div class="flex flex-col w-[70px]">
                                        <div class="text-white text-xs font-bold leading-tight name-cell">${stock.name}</div>
                                        <div class="text-gray-500 text-[10px] flex items-center gap-1 mt-0.5">${stock.id} ${typeBadge}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-2 py-3 text-center align-middle">${groupBadge}</td>
                            <td class="px-2 py-3 text-right ${priceClass} text-sm">${stock.price}</td>
                            <td class="px-2 py-3 text-right ${priceClass} text-xs">${rateDisplay}</td>
                            <td class="px-2 py-3 text-right text-[10px] text-gray-500 font-mono">${stock.ma5}</td>
                            <td class="px-2 py-3 text-right text-[10px] text-gray-500 font-mono">${stock.ma10}</td>
                            <td class="px-2 py-3 text-[10px] text-gray-600 whitespace-nowrap">${stock.note || '-'}</td>
                        </tr>`;
                }).join('');
                this.ui.body.innerHTML = html;
            }
        }
        class AdminController {
            constructor() {
                this.ui = { owner: document.getElementById('repo-owner'), repo: document.getElementById('repo-name'), token: document.getElementById('github-token'), log: document.getElementById('admin-log'), btn: document.getElementById('btn-trigger') };
            }
            log(msg) { this.ui.log.classList.remove('hidden'); this.ui.log.innerHTML += `<div>> ${msg}</div>`; this.ui.log.scrollTop = this.ui.log.scrollHeight; }
            loadSettings() { this.ui.owner.value = localStorage.getItem('gh_owner')||''; this.ui.repo.value = localStorage.getItem('gh_repo')||''; this.ui.token.value = localStorage.getItem('gh_token')||''; }
            saveSettings() { localStorage.setItem('gh_owner', this.ui.owner.value.trim()); localStorage.setItem('gh_repo', this.ui.repo.value.trim()); localStorage.setItem('gh_token', this.ui.token.value.trim()); }
            async triggerWorkflow() {
                const owner = this.ui.owner.value.trim(), repo = this.ui.repo.value.trim(), token = this.ui.token.value.trim();
                if (!owner || !repo || !token) { alert("請填寫所有欄位"); return; }
                this.saveSettings(); this.ui.btn.disabled = true; this.log('發送請求...');
                try {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/daily_scan.yml/dispatches`, {
                        method: 'POST', headers: { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `token ${token}` }, body: JSON.stringify({ ref: 'main' })
                    });
                    if (res.status === 204) { this.log('<span class="text-green-400">成功! 請稍後重整。</span>'); alert("掃描已啟動！請約 3-5 分鐘後重新整理網頁。"); }
                    else throw new Error(res.status);
                } catch (e) { this.log(`<span class="text-red-400">失敗: ${e.message}</span>`); } 
                finally { this.ui.btn.disabled = false; }
            }
        }
        const app = new StockApp(); const admin = new AdminController();
    </script>
</body>
</html>
