<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>台股自動化戰情室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        .tw-up { color: #ef4444; } .tw-down { color: #22c55e; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: #e2e8f0; overscroll-behavior-y: contain; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .tab-btn.active { color: #60a5fa; border-bottom: 2px solid #60a5fa; }
        .tab-btn { color: #94a3b8; border-bottom: 2px solid transparent; transition: all 0.3s; }
        th.sortable { cursor: pointer; transition: background-color 0.2s; user-select: none; white-space: nowrap; padding: 0.5rem 0; font-size: 10px; }
        th.sortable:hover { background-color: #334155; }
        td { white-space: nowrap; }
        .name-cell { white-space: normal; max-width: 80px; line-height: 1.2; }
        @keyframes pulse-blue { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-updating { animation: pulse-blue 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; color: #60a5fa; }
        .sort-symbol { display: inline-block; font-size: 8px; margin-left: 1px; vertical-align: 1px; color: #64748b; opacity: 0.5; transform: scale(0.9); }
        .sort-symbol.active { color: #60a5fa; opacity: 1; font-weight: bold; }
        .stat-card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 6px 10px; min-width: 80px; text-align: center; flex-shrink: 0; display: flex; flex-direction: column; gap: 2px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden bg-slate-900">
    <nav class="bg-slate-950 text-white p-2 shadow-lg shrink-0 z-40 border-b border-slate-800 flex justify-between items-center h-14">
        <div class="flex items-center gap-2 pl-1">
            <i class="fa-solid fa-robot text-emerald-400 text-lg"></i>
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <h1 class="text-sm font-bold tracking-wider leading-none">台股戰情室</h1>
                    <span id="win-rate-badge" class="hidden text-[9px] bg-slate-800 text-yellow-400 border border-yellow-600/30 px-1.5 py-0.5 rounded font-mono">勝率 -%</span>
                </div>
                <div class="text-[9px] text-gray-500 mt-0.5" id="last-updated">讀取中...</div>
            </div>
        </div>
        <div class="flex items-center gap-1">
            <button onclick="app.triggerCloudUpdate()" id="btn-cloud-update" class="flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-blue-400 border border-slate-700 px-3 py-1.5 rounded-full transition-all active:scale-95 shadow-sm">
                <i class="fa-solid fa-cloud-arrow-down text-sm"></i><span class="text-[10px] font-medium">更新</span>
            </button>
            <button onclick="app.refresh()" class="p-2 text-gray-500 hover:text-white transition-colors active:scale-95"><i class="fa-solid fa-rotate-right text-sm"></i></button>
        </div>
    </nav>

    <main class="flex-grow flex flex-col w-full max-w-6xl mx-auto p-2 overflow-hidden relative pb-16">
        <div id="page-heatmap" class="flex flex-col h-full gap-2">
            <div class="flex-grow overflow-y-auto pb-4"><div id="heatmap-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div></div>
        </div>
        <div id="page-list" class="hidden flex flex-col h-full gap-2">
            <div class="shrink-0 flex flex-col gap-2">
                <div class="flex justify-between items-center bg-slate-800/50 p-2 rounded-lg border border-slate-700">
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar flex-grow mr-2">
                        <span id="filter-tag" class="hidden text-[10px] bg-blue-900/50 text-blue-200 px-2 py-0.5 rounded border border-blue-700 flex items-center whitespace-nowrap"><span id="filter-name">族群</span><button onclick="app.clearFilter()" class="ml-2 hover:text-white"><i class="fa-solid fa-times"></i></button></span>
                        <span id="data-count" class="text-[10px] text-gray-400 font-mono whitespace-nowrap">總: 0</span>
                        <span class="flex items-center gap-1 text-[10px] text-blue-300 whitespace-nowrap"><span class="w-1.5 h-1.5 rounded-full bg-blue-400 inline-block"></span>拉回:<span id="count-pullback" class="font-bold">0</span></span>
                        <span class="flex items-center gap-1 text-[10px] text-purple-300 whitespace-nowrap"><span class="w-1.5 h-1.5 rounded-full bg-purple-400 inline-block"></span>VCP:<span id="count-vcp" class="font-bold">0</span></span>
                        <span class="flex items-center gap-1 text-[10px] text-orange-300 whitespace-nowrap"><span class="w-1.5 h-1.5 rounded-full bg-orange-400 inline-block"></span>N字:<span id="count-nshape" class="font-bold">0</span></span>
                    </div>
                    <button onclick="app.toggleMaFilter()" id="btn-ma-filter" class="bg-slate-700 text-gray-300 text-[10px] font-bold py-1 px-2.5 rounded shadow active:scale-95 transition-all whitespace-nowrap flex-shrink-0">過濾支撐</button>
                </div>
            </div>
            <div class="glass-panel flex-grow flex flex-col overflow-hidden rounded-xl border border-white/10">
                <div class="flex-grow overflow-auto bg-slate-900 relative">
                    <table class="min-w-[480px] w-full text-sm text-left text-gray-400">
                        <thead class="text-[10px] text-gray-500 uppercase bg-slate-950 sticky top-0 shadow-sm z-20">
                            <tr>
                                <th class="px-1 py-2 sortable sticky left-0 bg-slate-950 z-30 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] border-r border-slate-800 text-gray-300" onclick="app.sortList('id')">股名<span class="sort-symbol" id="sort-symbol-id">⇅</span></th>
                                <th class="px-1 py-2 sortable text-center" onclick="app.sortList('group')">族群<span class="sort-symbol" id="sort-symbol-group">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable" onclick="app.sortList('price')">價<span class="sort-symbol" id="sort-symbol-price">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable" onclick="app.sortList('changeRate')">漲跌<span class="sort-symbol" id="sort-symbol-changeRate">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-400" onclick="app.sortList('ma5')">MA5<span class="sort-symbol" id="sort-symbol-ma5">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-400" onclick="app.sortList('ma10')">MA10<span class="sort-symbol" id="sort-symbol-ma10">⇅</span></th>
                                <th class="px-1 py-2 text-[10px] sortable" onclick="app.sortList('note')">備註<span class="sort-symbol" id="sort-symbol-note">⇅</span></th>
                            </tr>
                        </thead>
                        <tbody id="result-body" class="divide-y divide-slate-800"><tr><td colspan="7" class="px-6 py-20 text-center text-gray-600">載入中...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="page-perf" class="hidden flex flex-col h-full gap-2">
            <div class="shrink-0 flex gap-2 overflow-x-auto pb-2 pl-1 no-scrollbar items-center" id="perf-stats-bar"><div class="text-xs text-gray-500 p-2">計算中...</div></div>
            <div class="glass-panel flex-grow flex flex-col overflow-hidden rounded-xl border border-white/10">
                <div class="flex-grow overflow-auto bg-slate-900 relative">
                    <table class="min-w-[850px] w-full text-sm text-left text-gray-400">
                        <thead class="text-[10px] text-gray-500 uppercase bg-slate-950 sticky top-0 shadow-sm z-20">
                            <tr>
                                <th class="px-1 py-2 sortable sticky left-0 bg-slate-950 z-30 border-r border-slate-800" onclick="app.sortPerfList('date')">日期<span class="sort-symbol" id="perf-symbol-date">⇅</span></th>
                                <th class="px-1 py-2 sortable sticky left-[40px] bg-slate-950 z-30 border-r border-slate-800 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)]" onclick="app.sortPerfList('id')">股名<span class="sort-symbol" id="perf-symbol-id">⇅</span></th>
                                <th class="px-1 py-2 text-center sortable border-r border-slate-800" onclick="app.sortPerfList('strategy')">策略<span class="sort-symbol" id="perf-symbol-strategy">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable" onclick="app.sortPerfList('buy_price')">進場<span class="sort-symbol" id="perf-symbol-buy_price">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable" onclick="app.sortPerfList('latest_price')">現價<span class="sort-symbol" id="perf-symbol-latest_price">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable" onclick="app.sortPerfList('roi')">累%<span class="sort-symbol" id="perf-symbol-roi">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable" onclick="app.sortPerfList('daily_change')">日%<span class="sort-symbol" id="perf-symbol-daily_change">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-300" onclick="app.sortPerfList('roi_1')">1日<span class="sort-symbol" id="perf-symbol-roi_1">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-300" onclick="app.sortPerfList('roi_5')">5日<span class="sort-symbol" id="perf-symbol-roi_5">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-300" onclick="app.sortPerfList('roi_10')">10日<span class="sort-symbol" id="perf-symbol-roi_10">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-300" onclick="app.sortPerfList('roi_20')">20日<span class="sort-symbol" id="perf-symbol-roi_20">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-300" onclick="app.sortPerfList('roi_30')">30日<span class="sort-symbol" id="perf-symbol-roi_30">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-300" onclick="app.sortPerfList('roi_60')">60日<span class="sort-symbol" id="perf-symbol-roi_60">⇅</span></th>
                                <th class="px-1 py-2 text-right sortable text-gray-300" onclick="app.sortPerfList('roi_120')">120日<span class="sort-symbol" id="perf-symbol-roi_120">⇅</span></th>
                            </tr>
                        </thead>
                        <tbody id="perf-body" class="divide-y divide-slate-800"><tr><td colspan="14" class="px-6 py-20 text-center text-gray-600">尚無歷史資料</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="page-admin" class="hidden h-full overflow-y-auto">
            <div class="glass-panel rounded-xl p-6 max-w-2xl mx-auto mb-4 bg-slate-800">
                <h2 class="text-lg font-bold mb-4 flex items-center border-b border-slate-700 pb-3 text-white"><i class="fa-solid fa-gear mr-2 text-gray-400"></i>設定</h2>
                <div class="space-y-3 text-sm">
                    <p class="text-xs text-yellow-500 bg-yellow-900/20 p-2 rounded border border-yellow-800"><i class="fa-solid fa-circle-info mr-1"></i> 請填寫 Token 以啟用雲端更新。</p>
                    <input type="text" id="repo-owner" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white placeholder-gray-500" placeholder="GitHub Owner">
                    <input type="text" id="repo-name" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white placeholder-gray-500" placeholder="Repo Name">
                    <input type="password" id="github-token" class="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white placeholder-gray-500" placeholder="Access Token">
                    <button onclick="admin.saveSettings()" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded mt-2">儲存設定</button>
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-800 z-50 h-16 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)]">
        <div class="max-w-6xl mx-auto flex justify-around h-full">
            <button onclick="app.switchTab('heatmap')" id="tab-heatmap" class="tab-btn active flex-1 flex flex-col items-center justify-center"><i class="fa-solid fa-fire text-lg mb-1"></i><span class="text-xs mt-1">熱力圖</span></button>
            <button onclick="app.switchTab('list')" id="tab-list" class="tab-btn flex-1 flex flex-col items-center justify-center"><i class="fa-solid fa-list-ul text-lg mb-1"></i><span class="text-xs mt-1">報價</span></button>
            <button onclick="app.switchTab('perf')" id="tab-perf" class="tab-btn flex-1 flex flex-col items-center justify-center"><i class="fa-solid fa-trophy text-lg mb-1"></i><span class="text-xs mt-1">績效</span></button>
            <button onclick="app.switchTab('admin')" id="tab-admin" class="tab-btn flex-1 flex flex-col items-center justify-center"><i class="fa-solid fa-gear text-lg mb-1"></i><span class="text-xs mt-1">設定</span></button>
        </div>
    </nav>

    <script>
        class StockApp {
            constructor() {
                this.dataUrl = 'data.json';
                this.historyUrl = 'history.json';
                this.stockList = []; 
                this.displayList = []; 
                this.historyList = []; 
                
                this.state = {
                    sortBy: 'changeRate', sortDir: 'desc',
                    perfSortBy: 'date', perfSortDir: 'desc', 
                    filterGroup: null, filterMa: false
                };

                this.lastDataTime = "";
                this.isPolling = false; 

                this.ui = {
                    body: document.getElementById('result-body'),
                    perfBody: document.getElementById('perf-body'),
                    perfStatsBar: document.getElementById('perf-stats-bar'),
                    lastUpdated: document.getElementById('last-updated'),
                    dataCount: document.getElementById('data-count'),
                    filterTag: document.getElementById('filter-tag'),
                    filterName: document.getElementById('filter-name'),
                    heatmapContainer: document.getElementById('heatmap-container'),
                    btnCloudUpdate: document.getElementById('btn-cloud-update'),
                    btnMaFilter: document.getElementById('btn-ma-filter'),
                    winRateBadge: document.getElementById('win-rate-badge'),
                    countPullback: document.getElementById('count-pullback'),
                    countVcp: document.getElementById('count-vcp'),
                    countNShape: document.getElementById('count-nshape'),
                    pageHeatmap: document.getElementById('page-heatmap'),
                    pageList: document.getElementById('page-list'),
                    pagePerf: document.getElementById('page-perf'),
                    pageAdmin: document.getElementById('page-admin'),
                    tabHeatmap: document.getElementById('tab-heatmap'),
                    tabList: document.getElementById('tab-list'),
                    tabPerf: document.getElementById('tab-perf'),
                    tabAdmin: document.getElementById('tab-admin')
                };
                this.init();
            }

            refresh() { location.reload(); }

            switchTab(tabName) {
                ['pageHeatmap', 'pageList', 'pagePerf', 'pageAdmin'].forEach(p => this.ui[p].classList.add('hidden'));
                ['tabHeatmap', 'tabList', 'tabPerf', 'tabAdmin'].forEach(t => this.ui[t].classList.remove('active'));

                if (tabName === 'heatmap') {
                    this.ui.pageHeatmap.classList.remove('hidden');
                    this.ui.tabHeatmap.classList.add('active');
                    this.renderHeatmap();
                } else if (tabName === 'list') {
                    this.ui.pageList.classList.remove('hidden');
                    this.ui.tabList.classList.add('active');
                    this.applyStateAndRender();
                } else if (tabName === 'perf') {
                    this.ui.pagePerf.classList.remove('hidden');
                    this.ui.tabPerf.classList.add('active');
                    this.sortPerfList(this.state.perfSortBy); 
                } else if (tabName === 'admin') {
                    this.ui.pageAdmin.classList.remove('hidden');
                    this.ui.tabAdmin.classList.add('active');
                    admin.loadSettings();
                }
            }

            async init() {
                try { 
                    await this.loadData(); 
                    this.loadHistory(); 
                } 
                catch (e) { this.ui.body.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-amber-500 text-xs">${e.message}</td></tr>`; }
            }

            async loadData() {
                const cacheBuster = new Date().getTime();
                try { 
                    const response = await fetch(`${this.dataUrl}?t=${cacheBuster}`); 
                    if (!response.ok) throw new Error("讀取失敗");
                    const data = await response.json();
                    this.stockList = data.list || [];
                    if (this.lastDataTime && this.lastDataTime !== data.date) {
                        this.stopPolling();
                        this.loadHistory(); 
                    }
                    this.lastDataTime = data.date;
                    this.ui.lastUpdated.innerText = `更新: ${data.date.split(' ')[1] || data.date}`;
                    this.renderHeatmap();
                    this.applyStateAndRender();
                } catch (e) { this.ui.body.innerHTML = `<tr><td colspan="7" class="px-6 py-20 text-center text-gray-600">載入中...</td></tr>`; }
            }

            async loadHistory() {
                try {
                    const cacheBuster = new Date().getTime();
                    const res = await fetch(`${this.historyUrl}?t=${cacheBuster}`);
                    if(res.ok) {
                        const historyData = await res.json();
                        this.historyList = [];
                        let totalStocks = 0;
                        let winStocks = 0;

                        Object.keys(historyData).forEach(date => {
                            const entryDate = new Date(date);
                            const today = new Date();
                            const diffDays = Math.ceil(Math.abs(today - entryDate) / (1000 * 60 * 60 * 24));

                            historyData[date].forEach(stock => {
                                const roi = parseFloat(stock.roi || 0);
                                
                                let strategy = '其他';
                                const note = stock.note || '';
                                const hasVCP = note.includes('Strict-VCP');
                                const hasPullback = note.includes('拉回佈局');
                                const hasNShape = note.includes('N字形');

                                let matchCount = 0;
                                if(hasVCP) matchCount++;
                                if(hasPullback) matchCount++;
                                if(hasNShape) matchCount++;

                                if (matchCount >= 2) strategy = '多策略';
                                else if (hasNShape) strategy = 'N字形';
                                else if (hasVCP) strategy = 'VCP';
                                else if (hasPullback) strategy = '拉回';

                                const stockObj = {
                                    ...stock,
                                    date: date, 
                                    daysHeld: diffDays,
                                    daily_change: parseFloat(stock.daily_change || 0),
                                    roi: roi,
                                    latest_price: parseFloat(stock.latest_price || 0),
                                    strategy: strategy,
                                    roi_1: stock.perf_1d,
                                    roi_5: stock.perf_5d,
                                    roi_10: stock.perf_10d,
                                    roi_20: stock.perf_20d,
                                    roi_30: stock.perf_30d,
                                    roi_60: stock.perf_60d,
                                    roi_120: stock.perf_120d
                                };
                                this.historyList.push(stockObj);
                                totalStocks++;
                                if (roi > 0) winStocks++;
                            });
                        });

                        if (totalStocks > 0) {
                            const winRate = Math.round((winStocks / totalStocks) * 100);
                            this.ui.winRateBadge.innerText = `總勝率 ${winRate}%`;
                            this.ui.winRateBadge.classList.remove('hidden');
                            if(winRate >= 60) this.ui.winRateBadge.className = "ml-2 text-[9px] bg-red-900/50 text-red-300 border border-red-700 px-1.5 py-0.5 rounded font-mono";
                            else if(winRate < 40) this.ui.winRateBadge.className = "ml-2 text-[9px] bg-green-900/50 text-green-300 border border-green-700 px-1.5 py-0.5 rounded font-mono";
                            else this.ui.winRateBadge.className = "ml-2 text-[9px] bg-slate-800 text-yellow-400 border border-yellow-600/30 px-1.5 py-0.5 rounded font-mono";
                        }
                        
                        // 計算統計數據
                        const stats = {
                            1: { total: 0, win: 0, sumRoi: 0 },
                            5: { total: 0, win: 0, sumRoi: 0 },
                            10: { total: 0, win: 0, sumRoi: 0 },
                            20: { total: 0, win: 0, sumRoi: 0 },
                            30: { total: 0, win: 0, sumRoi: 0 },
                            60: { total: 0, win: 0, sumRoi: 0 },
                            120: { total: 0, win: 0, sumRoi: 0 }
                        };
                        this.historyList.forEach(s => {
                            [1, 5, 10, 20, 30, 60, 120].forEach(d => {
                                const val = s[`roi_${d}`];
                                if (val !== null && val !== undefined) {
                                    stats[d].total++;
                                    if (val > 0) stats[d].win++;
                                    stats[d].sumRoi += parseFloat(val);
                                }
                            });
                        });
                        this.renderPerfStats(stats);
                    }
                } catch(e) { console.log('No history'); }
            }

            renderPerfStats(stats) {
                let html = '';
                [1, 5, 10, 20, 30, 60, 120].forEach(d => {
                    const s = stats[d];
                    if (s.total > 0) {
                        const winRate = Math.round((s.win / s.total) * 100);
                        const avgRoi = (s.sumRoi / s.total).toFixed(1);
                        const color = avgRoi > 0 ? 'text-red-400' : (avgRoi < 0 ? 'text-green-400' : 'text-gray-400');
                        const border = avgRoi > 0 ? 'border-red-500/50 bg-red-900/20' : (avgRoi < 0 ? 'border-green-500/50 bg-green-900/20' : 'border-gray-500/30');
                        html += `<div class="stat-card ${border}"><div class="text-[9px] text-gray-400 font-medium mb-0.5">持有 > ${d}天</div><div class="text-xs font-bold text-white mb-0.5">勝率 ${winRate}%</div><div class="text-[10px] ${color} font-mono">均 ${avgRoi > 0 ? '+' : ''}${avgRoi}%</div></div>`;
                    }
                });
                if(html === '') html = '<span class="text-xs text-gray-500 p-2">累積資料中...</span>';
                this.ui.perfStatsBar.innerHTML = html;
            }

            sortPerfList(key) {
                if (this.state.perfSortBy === key) {
                    this.state.perfSortDir = this.state.perfSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.state.perfSortBy = key;
                    this.state.perfSortDir = 'desc'; 
                }
                const dir = this.state.perfSortDir === 'asc' ? 1 : -1;
                this.historyList.sort((a, b) => {
                    let valA = a[key], valB = b[key];
                    if (['latest_price', 'daily_change', 'roi', 'buy_price'].includes(key) || key.startsWith('roi_')) {
                        const vA = (valA === null || valA === undefined) ? -99999999 : parseFloat(valA);
                        const vB = (valB === null || valB === undefined) ? -99999999 : parseFloat(valB);
                        return (vA - vB) * dir;
                    }
                    if (key === 'date') return (new Date(valA) - new Date(valB)) * dir;
                    return (valA || '').localeCompare(valB || '', 'zh-Hant') * dir;
                });
                document.querySelectorAll('#page-perf .sort-symbol').forEach(el => { el.innerText = '⇅'; el.classList.remove('active'); });
                const activeSymbol = document.getElementById(`perf-symbol-${key}`);
                if(activeSymbol) { activeSymbol.innerText = this.state.perfSortDir === 'asc' ? '▲' : '▼'; activeSymbol.classList.add('active'); }
                this.renderPerformanceTable();
            }

            renderPerformanceTable() {
                if (this.historyList.length === 0) {
                    this.ui.perfBody.innerHTML = `<tr><td colspan="14" class="px-6 py-20 text-center text-gray-600">尚無歷史資料</td></tr>`;
                    return;
                }
                const html = this.historyList.map(s => {
                    const roi = parseFloat(s.roi);
                    const dayChg = parseFloat(s.daily_change);
                    const roiClass = roi > 0 ? 'text-red-400' : (roi < 0 ? 'text-green-400' : 'text-gray-400');
                    const dayClass = dayChg > 0 ? 'text-red-400' : (dayChg < 0 ? 'text-green-400' : 'text-gray-400');
                    
                    let strategyBadge = '';
                    if (s.strategy === 'VCP') strategyBadge = '<span class="text-[9px] text-purple-300 bg-purple-900/40 px-1 py-0.5 rounded border border-purple-700/50">VCP</span>';
                    else if (s.strategy === '拉回') strategyBadge = '<span class="text-[9px] text-blue-300 bg-blue-900/40 px-1 py-0.5 rounded border border-blue-700/50">拉回</span>';
                    else if (s.strategy === 'N字形') strategyBadge = '<span class="text-[9px] text-orange-300 bg-orange-900/40 px-1 py-0.5 rounded border border-orange-700/50">N字</span>';
                    else if (s.strategy === '多策略') strategyBadge = '<span class="text-[9px] text-yellow-300 bg-yellow-900/40 px-1 py-0.5 rounded border border-yellow-700/50">多重</span>';
                    else strategyBadge = '<span class="text-[9px] text-gray-400">-</span>';

                    const cols = [1, 5, 10, 20, 30, 60, 120].map(d => {
                        const val = s[`roi_${d}`];
                        if (val !== null && val !== undefined) {
                            const v = parseFloat(val);
                            const c = v > 0 ? 'text-red-400' : (v < 0 ? 'text-green-400' : 'text-gray-500');
                            return `<td class="px-1 py-2 text-right text-[10px] ${c}">${v > 0 ? '+' : ''}${v}%</td>`;
                        } else {
                            return `<td class="px-1 py-2 text-right text-[10px] text-gray-600">-</td>`;
                        }
                    }).join('');

                    return `
                        <tr class="hover:bg-slate-800 transition-colors border-b border-slate-800">
                            <td class="px-1 py-2 sticky left-0 bg-slate-900 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] border-r border-slate-800 z-10 text-[10px] text-gray-400 min-w-[30px]">${s.date.substring(5)}</td>
                            <td class="px-1 py-2 sticky left-[30px] bg-slate-900 z-10 text-xs font-bold min-w-[50px] border-r border-slate-800 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)]">
                                <a href="https://tw.stock.yahoo.com/quote/${s.id}${s.type === '上市' ? '.TW' : '.TWO'}/technical-analysis" target="_blank" class="block hover:opacity-80 group">
                                    <div class="text-blue-400 group-hover:text-blue-300 underline decoration-blue-400/30">${s.name}</div>
                                    <div class="text-[9px] text-gray-500 font-normal no-underline">${s.id}</div>
                                </a>
                            </td>
                            <td class="px-1 py-2 text-center border-r border-slate-800/50">${strategyBadge}</td>
                            <td class="px-1 py-2 text-right text-xs text-gray-500">${s.buy_price}</td>
                            <td class="px-1 py-2 text-right text-xs text-gray-300">${s.latest_price}</td>
                            <td class="px-1 py-2 text-right text-xs ${roiClass} font-bold">${roi > 0 ? '+' : ''}${roi}%</td>
                            <td class="px-1 py-2 text-right text-xs ${dayClass}">${dayChg > 0 ? '+' : ''}${dayChg}%</td>
                            ${cols}
                        </tr>
                    `;
                }).join('');
                this.ui.perfBody.innerHTML = html;
            }

            applyStateAndRender() {
                let list = [...this.stockList];
                if (this.state.filterGroup) {
                    list = list.filter(s => (s.group || '其他') === this.state.filterGroup);
                    this.ui.filterTag.classList.remove('hidden');
                    this.ui.filterName.innerText = this.state.filterGroup;
                } else { this.ui.filterTag.classList.add('hidden'); }

                if (this.state.filterMa) {
                    list = list.filter(s => parseFloat(s.price) > parseFloat(s.ma5) && parseFloat(s.price) > parseFloat(s.ma10));
                    this.ui.btnMaFilter.classList.remove('bg-slate-700', 'text-gray-300');
                    this.ui.btnMaFilter.classList.add('bg-indigo-600', 'text-white');
                } else {
                    this.ui.btnMaFilter.classList.add('bg-slate-700', 'text-gray-300');
                    this.ui.btnMaFilter.classList.remove('bg-indigo-600', 'text-white');
                }

                let pbCount = 0;
                let vcpCount = 0;
                let nShapeCount = 0;
                list.forEach(s => {
                    if (s.note && s.note.includes('拉回佈局')) pbCount++;
                    if (s.note && s.note.includes('Strict-VCP')) vcpCount++;
                    if (s.note && s.note.includes('N字形')) nShapeCount++;
                });
                this.ui.countPullback.innerText = pbCount;
                this.ui.countVcp.innerText = vcpCount;
                this.ui.countNShape.innerText = nShapeCount;
                this.ui.dataCount.innerText = `總: ${list.length}`; 

                if (this.state.sortBy) {
                    const dir = this.state.sortDir === 'asc' ? 1 : -1;
                    list.sort((a, b) => {
                        let valA = a[this.state.sortBy];
                        let valB = b[this.state.sortBy];
                        if (['price', 'changeRate', 'ma5', 'ma10'].includes(this.state.sortBy)) 
                            return (parseFloat(valA) - parseFloat(valB)) * dir;
                        return (valA || '').localeCompare(valB || '', 'zh-Hant') * dir;
                    });
                    document.querySelectorAll('#page-list .sort-symbol').forEach(el => { el.innerText = '⇅'; el.classList.remove('active'); });
                    const activeSymbol = document.getElementById(`sort-symbol-${this.state.sortBy}`);
                    if(activeSymbol) { activeSymbol.innerText = this.state.sortDir === 'asc' ? '▲' : '▼'; activeSymbol.classList.add('active'); }
                }
                this.displayList = list;
                this.renderTable(this.displayList);
            }

            renderTable(data) {
                if (!data || data.length === 0) {
                    this.ui.body.innerHTML = `<tr><td colspan="7" class="px-6 py-20 text-center text-gray-600">無符合條件的資料</td></tr>`;
                    return;
                }
                
                this.ui.body.innerHTML = data.map(stock => {
                    const changeRate = parseFloat(stock.changeRate);
                    const colorClass = changeRate > 0 ? 'tw-up' : (changeRate < 0 ? 'tw-down' : 'text-gray-400');
                    const priceColor = changeRate > 0 ? 'text-red-400' : (changeRate < 0 ? 'text-green-400' : 'text-gray-300');
                    const symbol = stock.type === '上市' ? '.TW' : '.TWO';
                    const yahooLink = `https://tw.stock.yahoo.com/quote/${stock.id}${symbol}/technical-analysis`;
                    
                    let noteHtml = stock.note || '';
                    noteHtml = noteHtml.replace('Strict-VCP', '<span class="text-purple-300 bg-purple-900/30 px-1 rounded border border-purple-700/50">VCP</span>')
                                       .replace('拉回佈局', '<span class="text-blue-300 bg-blue-900/30 px-1 rounded border border-blue-700/50">拉回</span>')
                                       .replace('N字形', '<span class="text-orange-300 bg-orange-900/30 px-1 rounded border border-orange-700/50">N字</span>');

                    return `
                        <tr class="hover:bg-slate-800 transition-colors border-b border-slate-800">
                            <td class="px-1 py-2 sticky left-0 bg-slate-900 z-10 border-r border-slate-800 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)]">
                                <a href="${yahooLink}" target="_blank" class="block">
                                    <div class="font-bold text-blue-400 hover:text-blue-300 hover:underline">${stock.name}</div>
                                    <div class="text-[9px] text-gray-500">${stock.id}</div>
                                </a>
                            </td>
                            <td class="px-1 py-2 text-center text-xs text-gray-400 cursor-pointer hover:text-white" onclick="app.filterByGroup('${stock.group}')">${stock.group}</td>
                            <td class="px-1 py-2 text-right font-mono text-sm ${priceColor}">${stock.price}</td>
                            <td class="px-1 py-2 text-right font-mono text-xs ${colorClass}">${changeRate > 0 ? '+' : ''}${changeRate}%</td>
                            <td class="px-1 py-2 text-right font-mono text-xs text-gray-500">${stock.ma5}</td>
                            <td class="px-1 py-2 text-right font-mono text-xs text-gray-500">${stock.ma10}</td>
                            <td class="px-1 py-2 text-[10px] text-gray-400 truncate max-w-[120px]" title="${stock.note}">${noteHtml}</td>
                        </tr>
                    `;
                }).join('');
            }

            renderHeatmap() {
                if(!this.stockList || this.stockList.length === 0) {
                    this.ui.heatmapContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">無資料</div>';
                    return;
                }

                const groups = {};
                this.stockList.forEach(stock => {
                    const g = stock.group || '其他';
                    if (!groups[g]) {
                        groups[g] = { name: g, totalChange: 0, count: 0 };
                    }
                    groups[g].totalChange += parseFloat(stock.changeRate || 0);
                    groups[g].count += 1;
                });

                const groupArray = Object.values(groups).map(g => ({
                    name: g.name,
                    count: g.count,
                    avgChange: (g.totalChange / g.count).toFixed(2)
                }));

                groupArray.sort((a, b) => parseFloat(b.avgChange) - parseFloat(a.avgChange));
                
                this.ui.heatmapContainer.innerHTML = groupArray.map(g => {
                    const rate = parseFloat(g.avgChange);
                    let bgClass = 'bg-slate-800';
                    if(rate > 2) bgClass = 'bg-red-900/90 border-red-500/60';
                    else if(rate > 0) bgClass = 'bg-red-900/50 border-red-500/40';
                    else if(rate < -2) bgClass = 'bg-green-900/90 border-green-500/60';
                    else if(rate < 0) bgClass = 'bg-green-900/50 border-green-500/40';
                    else bgClass = 'bg-slate-800 border-gray-700';
                    
                    return `
                        <div onclick="app.filterByGroup('${g.name}')" 
                           class="${bgClass} border rounded p-1 flex flex-col items-center justify-center hover:scale-95 transition-transform cursor-pointer h-16 shadow-md group relative">
                            <div class="text-[10px] font-bold text-gray-200 text-center leading-tight z-10 truncate w-full px-1">${g.name}</div>
                            <div class="text-sm font-mono font-bold ${rate > 0 ? 'text-red-400' : (rate < 0 ? 'text-green-400' : 'text-gray-300')} z-10 my-0.5">
                                ${rate > 0 ? '+' : ''}${rate}%
                            </div>
                            <div class="px-1.5 py-0 bg-black/20 rounded-full text-[9px] text-gray-400 z-10 border border-white/5 leading-none">
                                ${g.count}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            filterByGroup(groupName) { this.state.filterGroup = groupName; this.state.filterMa = false; this.switchTab('list'); this.applyStateAndRender(); }
            clearFilter() { this.state.filterGroup = null; this.applyStateAndRender(); }
            toggleMaFilter() { this.state.filterMa = !this.state.filterMa; this.applyStateAndRender(); }
            sortList(key) {
                if (this.state.sortBy === key) { this.state.sortDir = this.state.sortDir === 'asc' ? 'desc' : 'asc'; } 
                else { this.state.sortBy = key; this.state.sortDir = 'asc'; }
                this.applyStateAndRender();
            }
            
            async triggerCloudUpdate() {
                const owner = localStorage.getItem('gh_owner');
                const repo = localStorage.getItem('gh_repo');
                const token = localStorage.getItem('gh_token');
                if (!owner || !repo || !token) { 
                    alert("⚠️ 錯誤：請先至 [設定] 頁面填寫 GitHub Token、Owner 與 Repo 名稱。"); 
                    this.switchTab('admin'); 
                    return; 
                }
                if (!confirm("確定要手動觸發雲端掃描嗎？\n(這會啟動 GitHub Actions)")) return;
                this.ui.btnCloudUpdate.disabled = true;
                this.ui.btnCloudUpdate.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin animate-updating"></i>`;
                try {
                    const workflowId = 'daily_scan.yml'; 
                    const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflowId}/dispatches`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `token ${token}`
                        },
                        body: JSON.stringify({ ref: 'main' }) 
                    });
                    
                    if (res.ok) {
                        alert("✅ 指令已發送！\nGithub 正在啟動掃描，請稍等 3~5 分鐘後自動更新。");
                        this.startPolling();
                    } else {
                        const errText = await res.text();
                        throw new Error(`Status ${res.status}: ${errText}`);
                    }
                } catch (e) {
                    alert(`❌ 發送失敗：${e.message}\n\n請檢查：\n1. Token 是否有 'workflow' 權限\n2. Repo 名稱是否正確\n3. .yml 檔名是否為 daily_scan.yml`);
                    this.resetUpdateButton();
                }
            }
            
            startPolling() {
                if (this.isPolling) return;
                this.isPolling = true;
                this.ui.lastUpdated.classList.add("animate-pulse", "text-blue-400");
                this.pollInterval = setInterval(() => { this.loadData(); }, 15000);
            }
            stopPolling() {
                this.isPolling = false;
                clearInterval(this.pollInterval);
                this.resetUpdateButton();
                this.ui.lastUpdated.classList.remove("animate-pulse", "text-blue-400");
            }
            resetUpdateButton() {
                this.ui.btnCloudUpdate.innerHTML = `<i class="fa-solid fa-cloud-arrow-down text-sm"></i><span class="text-[10px] font-medium">更新</span>`;
                this.ui.btnCloudUpdate.disabled = false;
            }
        }

        class AdminController {
            constructor() {
                this.ui = { owner: document.getElementById('repo-owner'), repo: document.getElementById('repo-name'), token: document.getElementById('github-token') };
            }
            loadSettings() { this.ui.owner.value = localStorage.getItem('gh_owner')||''; this.ui.repo.value = localStorage.getItem('gh_repo')||''; this.ui.token.value = localStorage.getItem('gh_token')||''; }
            saveSettings() { 
                localStorage.setItem('gh_owner', this.ui.owner.value.trim()); 
                localStorage.setItem('gh_repo', this.ui.repo.value.trim()); 
                localStorage.setItem('gh_token', this.ui.token.value.trim()); 
                alert('設定已儲存！');
            }
        }
        const app = new StockApp(); const admin = new AdminController();
    </script>
</body>
</html>
