<script>
        class StockApp {
            constructor() {
                this.dataUrl = 'data.json';
                this.historyUrl = 'history.json';
                this.stockList = []; 
                this.displayList = []; 
                this.historyList = []; 
                
                this.state = {
                    sortBy: 'changeRate', sortDir: 'desc',
                    perfSortBy: 'date', perfSortDir: 'desc', 
                    filterGroup: null, filterMa: false
                };

                this.lastDataTime = "";
                this.isPolling = false; 

                // UI References (保持不變)
                this.ui = {
                    body: document.getElementById('result-body'),
                    perfBody: document.getElementById('perf-body'),
                    perfStatsBar: document.getElementById('perf-stats-bar'),
                    lastUpdated: document.getElementById('last-updated'),
                    dataCount: document.getElementById('data-count'),
                    filterTag: document.getElementById('filter-tag'),
                    filterName: document.getElementById('filter-name'),
                    heatmapContainer: document.getElementById('heatmap-container'),
                    btnCloudUpdate: document.getElementById('btn-cloud-update'),
                    btnMaFilter: document.getElementById('btn-ma-filter'),
                    winRateBadge: document.getElementById('win-rate-badge'),
                    countPullback: document.getElementById('count-pullback'),
                    countVcp: document.getElementById('count-vcp'),
                    pageHeatmap: document.getElementById('page-heatmap'),
                    pageList: document.getElementById('page-list'),
                    pagePerf: document.getElementById('page-perf'),
                    pageAdmin: document.getElementById('page-admin'),
                    tabHeatmap: document.getElementById('tab-heatmap'),
                    tabList: document.getElementById('tab-list'),
                    tabPerf: document.getElementById('tab-perf'),
                    tabAdmin: document.getElementById('tab-admin')
                };
                this.init();
            }

            refresh() { location.reload(); }

            switchTab(tabName) {
                ['pageHeatmap', 'pageList', 'pagePerf', 'pageAdmin'].forEach(p => this.ui[p].classList.add('hidden'));
                ['tabHeatmap', 'tabList', 'tabPerf', 'tabAdmin'].forEach(t => this.ui[t].classList.remove('active'));

                if (tabName === 'heatmap') {
                    this.ui.pageHeatmap.classList.remove('hidden');
                    this.ui.tabHeatmap.classList.add('active');
                    this.renderHeatmap(); // 每次切換都重新渲染，確保大小正確
                } else if (tabName === 'list') {
                    this.ui.pageList.classList.remove('hidden');
                    this.ui.tabList.classList.add('active');
                    this.applyStateAndRender();
                } else if (tabName === 'perf') {
                    this.ui.pagePerf.classList.remove('hidden');
                    this.ui.tabPerf.classList.add('active');
                    this.sortPerfList(this.state.perfSortBy); 
                } else if (tabName === 'admin') {
                    this.ui.pageAdmin.classList.remove('hidden');
                    this.ui.tabAdmin.classList.add('active');
                    admin.loadSettings();
                }
            }

            async init() {
                try { 
                    await this.loadData(); 
                    await this.loadHistory(); 
                } 
                catch (e) { this.ui.body.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-amber-500 text-xs">${e.message}</td></tr>`; }
            }

            async loadData() {
                const cacheBuster = new Date().getTime();
                let response;
                try { response = await fetch(`${this.dataUrl}?v=${cacheBuster}`); } // 改用 v= 比較標準
                catch (netError) { throw new Error("無法讀取資料 (網路錯誤)"); }
                
                if (response.status === 404) throw new Error("尚未生成資料，請至設定頁觸發掃描");
                if (!response.ok) throw new Error("資料讀取失敗");
                
                const data = await response.json();
                this.stockList = data.list || [];
                
                // 檢查是否真的有新資料
                if (this.lastDataTime && this.lastDataTime !== data.date) {
                    // 如果正在輪詢，且發現資料變了，停止輪詢並通知
                    if(this.isPolling) {
                        alert(`✅ 雲端運算完成！\n資料時間: ${data.date}`);
                        this.stopPolling();
                    }
                    this.loadHistory(); 
                }
                
                this.lastDataTime = data.date;
                this.ui.lastUpdated.innerText = `更新: ${data.date.split(' ')[1] || data.date}`;
                
                this.renderHeatmap();
                this.applyStateAndRender();
            }

            async loadHistory() {
                try {
                    const cacheBuster = new Date().getTime();
                    const res = await fetch(`${this.historyUrl}?v=${cacheBuster}`);
                    if(res.ok) {
                        const historyData = await res.json();
                        this.historyList = [];
                        let totalStocks = 0;
                        let winStocks = 0;

                        Object.keys(historyData).forEach(date => {
                            const entryDate = new Date(date);
                            const today = new Date();
                            const diffTime = Math.abs(today - entryDate);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            historyData[date].forEach(stock => {
                                const roi = parseFloat(stock.roi || 0);
                                this.historyList.push({
                                    ...stock,
                                    date: date, 
                                    daysHeld: diffDays,
                                    daily_change: parseFloat(stock.daily_change || 0),
                                    roi: roi,
                                    latest_price: parseFloat(stock.latest_price || 0)
                                });
                                totalStocks++;
                                if (roi > 0) winStocks++;
                            });
                        });

                        if (totalStocks > 0) {
                            const winRate = Math.round((winStocks / totalStocks) * 100);
                            this.ui.winRateBadge.innerText = `勝率 ${winRate}%`;
                            this.ui.winRateBadge.classList.remove('hidden');
                            if(winRate >= 60) this.ui.winRateBadge.className = "ml-2 text-[9px] bg-red-900/50 text-red-300 border border-red-700 px-1.5 py-0.5 rounded font-mono";
                            else if(winRate < 40) this.ui.winRateBadge.className = "ml-2 text-[9px] bg-green-900/50 text-green-300 border border-green-700 px-1.5 py-0.5 rounded font-mono";
                            else this.ui.winRateBadge.className = "ml-2 text-[9px] bg-slate-800 text-yellow-400 border border-yellow-600/30 px-1.5 py-0.5 rounded font-mono";
                        }
                        
                        // 計算統計數據 (保持原邏輯)
                        const stats = { 1: {t:0,w:0,r:0}, 5: {t:0,w:0,r:0}, 10: {t:0,w:0,r:0}, 20: {t:0,w:0,r:0}, 30: {t:0,w:0,r:0}, 60: {t:0,w:0,r:0}, 120: {t:0,w:0,r:0} };
                        this.historyList.forEach(s => {
                            [1, 5, 10, 20, 30, 60, 120].forEach(d => {
                                if (s.daysHeld >= d) {
                                    stats[d].t++;
                                    if (s.roi > 0) stats[d].w++;
                                    stats[d].r += s.roi;
                                }
                            });
                        });
                        this.renderPerfStats(stats);
                    }
                } catch(e) { console.log('No history'); }
            }

            renderPerfStats(stats) {
                let html = '';
                [1, 5, 10, 20, 30, 60, 120].forEach(d => {
                    const s = stats[d];
                    if (s.t > 0) {
                        const winRate = Math.round((s.w / s.t) * 100);
                        const avgRoi = (s.r / s.t).toFixed(1);
                        const color = avgRoi > 0 ? 'text-red-400' : (avgRoi < 0 ? 'text-green-400' : 'text-gray-400');
                        const border = avgRoi > 0 ? 'border-red-500/30' : 'border-green-500/30';
                        
                        html += `
                            <div class="stat-card flex flex-col justify-center ${border}">
                                <div class="text-[9px] text-gray-400">${d}日 (${s.t})</div>
                                <div class="text-xs font-bold text-white">勝 ${winRate}%</div>
                                <div class="text-[10px] font-bold ${color}">${avgRoi > 0 ? '+' : ''}${avgRoi}%</div>
                            </div>
                        `;
                    }
                });
                if(html === '') html = '<span class="text-xs text-gray-500 pl-2">累積資料中...</span>';
                this.ui.perfStatsBar.innerHTML = html;
            }

            sortPerfList(key) {
                // (保持原邏輯，略微優化 NaN 處理)
                if (this.state.perfSortBy === key) {
                    this.state.perfSortDir = this.state.perfSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.state.perfSortBy = key;
                    this.state.perfSortDir = 'desc'; 
                }
                
                const dir = this.state.perfSortDir === 'asc' ? 1 : -1;
                this.historyList.sort((a, b) => {
                    let valA = a[key], valB = b[key];
                    if (['latest_price', 'daily_change', 'roi', 'buy_price'].includes(key) || key.startsWith('roi_')) {
                        // 【優化】將無效數值視為極小值，排在最後
                        valA = (valA === undefined || valA === null || isNaN(valA)) ? -999999 : parseFloat(valA);
                        valB = (valB === undefined || valB === null || isNaN(valB)) ? -999999 : parseFloat(valB);
                        return (valA - valB) * dir;
                    }
                    if (key === 'date') return (new Date(valA) - new Date(valB)) * dir;
                    return (valA || '').localeCompare(valB || '', 'zh-Hant') * dir;
                });

                document.querySelectorAll('#page-perf .sort-symbol').forEach(el => { el.innerText = '⇅'; el.classList.remove('active'); });
                const activeSymbol = document.getElementById(`perf-symbol-${key}`);
                if(activeSymbol) { activeSymbol.innerText = this.state.perfSortDir === 'asc' ? '▲' : '▼'; activeSymbol.classList.add('active'); }

                this.renderPerformanceTable();
            }

            renderPerformanceTable() {
                // (保持原邏輯)
                if (this.historyList.length === 0) {
                    this.ui.perfBody.innerHTML = `<tr><td colspan="13" class="px-6 py-20 text-center text-gray-600">尚無歷史資料</td></tr>`;
                    return;
                }
                const html = this.historyList.map(s => {
                    const roi = parseFloat(s.roi);
                    const dayChg = parseFloat(s.daily_change);
                    const roiClass = roi > 0 ? 'text-red-400' : (roi < 0 ? 'text-green-400' : 'text-gray-400');
                    const dayClass = dayChg > 0 ? 'text-red-400' : (dayChg < 0 ? 'text-green-400' : 'text-gray-400');
                    const dateDisplay = s.date.substring(5);
                    const suffix = s.type === '上市' ? '.TW' : '.TWO';
                    const linkUrl = `https://tw.stock.yahoo.com/quote/${s.id}${suffix}/technical-analysis`;

                    const cols = [1, 5, 10, 20, 30, 60, 120].map(d => {
                        if (s.daysHeld >= d) {
                            const c = roi > 0 ? 'text-red-400' : (roi < 0 ? 'text-green-400' : 'text-gray-500');
                            return `<td class="px-1 py-2 text-right text-[10px] ${c}">${roi > 0 ? '+' : ''}${roi}%</td>`;
                        } else {
                            return `<td class="px-1 py-2 text-right text-[10px] text-gray-600">-</td>`;
                        }
                    }).join('');

                    return `
                        <tr class="hover:bg-slate-800 transition-colors border-b border-slate-800">
                            <td class="px-1 py-2 sticky left-0 bg-slate-900 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] border-r border-slate-800 z-10 text-[10px] text-gray-400 min-w-[30px]">${dateDisplay}</td>
                            <td class="px-1 py-2 sticky left-[30px] bg-slate-900 z-10 text-xs font-bold min-w-[50px] border-r border-slate-800 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)]">
                                <a href="${linkUrl}" target="_blank" class="block hover:opacity-80 group">
                                    <div class="text-blue-400 group-hover:text-blue-300 underline decoration-blue-400/30">${s.name}</div>
                                    <div class="text-[9px] text-gray-500 font-normal no-underline">${s.id}</div>
                                </a>
                            </td>
                            <td class="px-1 py-2 text-right text-xs text-gray-500">${s.buy_price}</td>
                            <td class="px-1 py-2 text-right text-xs text-gray-300">${s.latest_price}</td>
                            <td class="px-1 py-2 text-right text-xs ${roiClass} font-bold">${roi > 0 ? '+' : ''}${roi}%</td>
                            <td class="px-1 py-2 text-right text-xs ${dayClass}">${dayChg > 0 ? '+' : ''}${dayChg}%</td>
                            ${cols}
                        </tr>
                    `;
                }).join('');
                this.ui.perfBody.innerHTML = html;
            }

            applyStateAndRender() {
                let list = [...this.stockList];
                
                let pbCount = 0;
                let vcpCount = 0;
                list.forEach(s => {
                    if (s.note && s.note.includes('拉回佈局')) pbCount++;
                    if (s.note && s.note.includes('VCP')) vcpCount++;
                });
                
                this.ui.countPullback.innerText = pbCount;
                this.ui.countVcp.innerText = vcpCount;
                this.ui.dataCount.innerText = `總: ${list.length}`; 

                if (this.state.filterGroup) {
                    list = list.filter(s => (s.group || '其他') === this.state.filterGroup);
                    this.ui.filterTag.classList.remove('hidden');
                    this.ui.filterName.innerText = this.state.filterGroup;
                } else { this.ui.filterTag.classList.add('hidden'); }

                if (this.state.filterMa) {
                    list = list.filter(s => {
                        const p = parseFloat(s.price);
                        const m5 = parseFloat(s.ma5);
                        const m10 = parseFloat(s.ma10);
                        // 【優化】防止 NaN 錯誤，如果沒均線資料就不顯示
                        if(isNaN(p) || isNaN(m5) || isNaN(m10)) return false;
                        return p > m5 && p > m10;
                    });
                    this.ui.btnMaFilter.classList.remove('bg-slate-700', 'text-gray-300');
                    this.ui.btnMaFilter.classList.add('bg-indigo-600', 'text-white');
                } else {
                    this.ui.btnMaFilter.classList.add('bg-slate-700', 'text-gray-300');
                    this.ui.btnMaFilter.classList.remove('bg-indigo-600', 'text-white');
                }

                if (this.state.sortBy) {
                    const dir = this.state.sortDir === 'asc' ? 1 : -1;
                    list.sort((a, b) => {
                        let valA = a[this.state.sortBy];
                        let valB = b[this.state.sortBy];
                        
                        if (['price', 'changeRate', 'ma5', 'ma10'].includes(this.state.sortBy)) {
                            // 【關鍵優化】處理非數字排序
                            valA = parseFloat(valA);
                            valB = parseFloat(valB);
                            
                            // 把無效數值 (NaN) 排到最後面
                            if (isNaN(valA)) return 1; 
                            if (isNaN(valB)) return -1;
                            
                            return (valA - valB) * dir;
                        }
                        return (valA || '').localeCompare(valB || '', 'zh-Hant') * dir;
                    });
                    
                    document.querySelectorAll('#page-list .sort-symbol').forEach(el => { el.innerText = '⇅'; el.classList.remove('active'); });
                    const activeSymbol = document.getElementById(`sort-symbol-${this.state.sortBy}`);
                    if(activeSymbol) { activeSymbol.innerText = this.state.sortDir === 'asc' ? '▲' : '▼'; activeSymbol.classList.add('active'); }
                }
                this.displayList = list;
                this.renderTable(this.displayList);
                this.updateCount();
            }

            filterByGroup(groupName) { this.state.filterGroup = groupName; this.state.filterMa = false; this.switchTab('list'); this.applyStateAndRender(); }
            clearFilter() { this.state.filterGroup = null; this.applyStateAndRender(); }
            toggleMaFilter() { this.state.filterMa = !this.state.filterMa; this.applyStateAndRender(); }
            sortList(key) {
                if (this.state.sortBy === key) { this.state.sortDir = this.state.sortDir === 'asc' ? 'desc' : 'asc'; } 
                else { this.state.sortBy = key; this.state.sortDir = 'asc'; }
                this.applyStateAndRender();
            }
            
            async triggerCloudUpdate() {
                const owner = localStorage.getItem('gh_owner');
                const repo = localStorage.getItem('gh_repo');
                const token = localStorage.getItem('gh_token');
                
                if (!owner || !repo || !token) { 
                    alert("請先至設定頁填寫 Token"); 
                    this.switchTab('admin'); 
                    return; 
                }
                
                if (!confirm("確定要手動觸發雲端掃描嗎？\n(通常每日下午 3 點會自動執行)")) return;
                
                this.ui.btnCloudUpdate.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin animate-updating"></i>`;
                this.ui.btnCloudUpdate.disabled = true;
                
                try {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/daily_scan.yml/dispatches`, {
                        method: 'POST', 
                        headers: { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `token ${token}` }, 
                        body: JSON.stringify({ ref: 'main' })
                    });
                    
                    if (res.status === 204) { 
                        alert("✅ 指令發送成功！\n\n系統正在雲端掃描股票，請等待約 2 分鐘，\n完成後畫面會自動更新。");
                        this.startPolling(); 
                    } else { 
                        throw new Error(`Status ${res.status}`); 
                    }
                } catch (e) { 
                    alert("發送失敗：" + e.message); 
                    this.resetUpdateButton(); 
                }
            }
            
            startPolling() {
                if (this.isPolling) return;
                this.isPolling = true;
                this.ui.lastUpdated.innerText = "雲端運算中...";
                this.ui.lastUpdated.classList.add("animate-pulse", "text-blue-400");
                
                // 雲端跑 Action + Pages 更新 CDN 至少需要 60秒，我們每 20 秒檢查一次
                this.pollInterval = setInterval(() => { this.loadData(); }, 20000);
            }
            
            stopPolling() {
                this.isPolling = false;
                clearInterval(this.pollInterval);
                this.resetUpdateButton();
                this.ui.lastUpdated.classList.remove("animate-pulse", "text-blue-400");
            }
            
            resetUpdateButton() {
                this.ui.btnCloudUpdate.innerHTML = `<i class="fa-solid fa-cloud-arrow-down text-sm"></i><span class="text-[10px] font-medium">更新</span>`;
                this.ui.btnCloudUpdate.disabled = false;
            }

            renderHeatmap() {
                if (this.stockList.length === 0) { this.ui.heatmapContainer.innerHTML = `<div class="col-span-full text-center text-gray-500 pt-10">無資料，請更新報價。</div>`; return; }
                const groups = {};
                this.stockList.forEach(stock => {
                    const gName = stock.group || '其他';
                    if (!groups[gName]) groups[gName] = { totalChange: 0, count: 0 };
                    // 【優化】防止 NaN
                    const change = parseFloat(stock.changeRate);
                    if(!isNaN(change)) {
                        groups[gName].totalChange += change;
                        groups[gName].count++;
                    }
                });
                
                const groupArray = Object.keys(groups).map(key => {
                    const count = groups[key].count;
                    const avg = count > 0 ? (groups[key].totalChange / count).toFixed(2) : 0;
                    return { name: key, avgChange: avg, count: count };
                }).sort((a, b) => b.avgChange - a.avgChange);

                this.ui.heatmapContainer.innerHTML = groupArray.map(g => {
                    const rate = parseFloat(g.avgChange);
                    let colorClass = 'bg-slate-700';
                    if (rate > 2) colorClass = 'bg-red-600';
                    else if (rate > 0) colorClass = 'bg-red-900/80';
                    else if (rate < -2) colorClass = 'bg-green-600';
                    else if (rate < 0) colorClass = 'bg-green-900/80';
                    
                    return `<div onclick="app.filterByGroup('${g.name}')" class="${colorClass} p-3 rounded-lg shadow cursor-pointer active:scale-95 transition-transform flex flex-col justify-between h-24 border border-white/10 hover:border-white/30"><span class="text-sm font-bold text-white truncate">${g.name}</span><div class="flex justify-between items-end"><span class="text-xs text-gray-300">${g.count}檔</span><span class="text-lg font-bold text-white">${rate>0?'+':''}${rate}%</span></div></div>`;
                }).join('');
            }

            renderTable(list) {
                if (list.length === 0) { this.ui.body.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">無符合篩選條件的資料</td></tr>`; return; }
                const html = list.map(stock => {
                    const rate = parseFloat(stock.changeRate||0);
                    // 【優化】防止 price 是 null 導致 crash
                    const priceVal = parseFloat(stock.price);
                    const price = isNaN(priceVal) ? '-' : priceVal.toFixed(2);
                    
                    let priceClass = rate > 0 ? 'tw-up font-bold' : (rate < 0 ? 'tw-down font-bold' : 'text-white font-bold');
                    let rateDisplay = rate > 0 ? `+${rate.toFixed(2)}%` : `${rate.toFixed(2)}%`;
                    
                    const typeBadge = stock.type === '上市' ? '<span class="bg-blue-900 text-blue-300 text-[9px] px-1 rounded border border-blue-800">市</span>' : '<span class="bg-purple-900 text-purple-300 text-[9px] px-1 rounded border border-purple-800">櫃</span>';
                    
                    let shortGroup = stock.group || '-';
                    if (shortGroup !== '-' && shortGroup !== '其他' && shortGroup.length > 2) shortGroup = shortGroup.substring(0, 2);
                    const groupBadge = stock.group && stock.group !== '其他' ? `<span class="bg-slate-800 text-gray-400 text-[10px] px-1 py-0.5 rounded border border-slate-700">${shortGroup}</span>` : `<span class="text-gray-600 text-[10px]">-</span>`;
                    
                    const suffix = stock.type === '上市' ? '.TW' : '.TWO';
                    const linkUrl = `https://tw.stock.yahoo.com/quote/${stock.id}${suffix}/technical-analysis`;

                    return `
                        <tr class="hover:bg-slate-800 transition-colors border-b border-slate-800">
                            <td class="px-1 py-2 sticky left-0 bg-slate-900 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.5)] border-r border-slate-800 z-10">
                                <a href="${linkUrl}" target="_blank" class="flex items-center gap-1.5 block hover:opacity-80 group">
                                    <div class="flex flex-col w-[70px]">
                                        <div class="text-blue-400 text-xs font-bold leading-tight name-cell underline decoration-blue-400/30 group-hover:text-blue-300">${stock.name}</div>
                                        <div class="text-gray-500 text-[10px] flex items-center gap-1 mt-0.5 no-underline">${stock.id} ${typeBadge}</div>
                                    </div>
                                </a>
                            </td>
                            <td class="px-1 py-2 text-center align-middle">${groupBadge}</td>
                            <td class="px-1 py-2 text-right ${priceClass} text-sm">${price}</td>
                            <td class="px-1 py-2 text-right ${priceClass} text-xs">${rateDisplay}</td>
                            <td class="px-1 py-2 text-right text-sm text-gray-500 font-mono">${stock.ma5 || '-'}</td>
                            <td class="px-1 py-2 text-right text-sm text-gray-500 font-mono">${stock.ma10 || '-'}</td>
                            <td class="px-1 py-2 text-[10px] text-gray-600 whitespace-nowrap">${stock.note || '-'}</td>
                        </tr>`;
                }).join('');
                this.ui.body.innerHTML = html;
            }
            updateCount() { this.ui.dataCount.innerText = `總: ${this.displayList.length} 檔`; }
        }

        class AdminController {
            constructor() {
                this.ui = { owner: document.getElementById('repo-owner'), repo: document.getElementById('repo-name'), token: document.getElementById('github-token') };
            }
            loadSettings() { this.ui.owner.value = localStorage.getItem('gh_owner')||''; this.ui.repo.value = localStorage.getItem('gh_repo')||''; this.ui.token.value = localStorage.getItem('gh_token')||''; }
            saveSettings() { 
                localStorage.setItem('gh_owner', this.ui.owner.value.trim()); 
                localStorage.setItem('gh_repo', this.ui.repo.value.trim()); 
                localStorage.setItem('gh_token', this.ui.token.value.trim()); 
                alert('設定已儲存！');
            }
        }
        const app = new StockApp(); const admin = new AdminController();
    </script>
